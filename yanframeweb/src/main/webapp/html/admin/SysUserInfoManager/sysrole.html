<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">

<body th:fragment="maincontent">

    <link rel="stylesheet" th:href="@{/static/css/zTreeStyle/zTreeStyle.css}" type="text/css">

    <form class="layui-form search_getSysRoleList_form" method="post" th:action="@{/SysUserInfoManagerController/getSysRoleList}">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label" style="text-align:center;" >角色名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="role_value"    class="layui-input">
                </div>
                <div class="layui-inline" style="float:right;">
                    <input type="button" class="layui-btn layui-btn-radius search_btn"   value="我要查询"></input>
                </div>
            </div>
        </div>
    </form>


<table class="layui-table"
       lay-data="{height:730, url:'/SysUserInfoManagerController/getSysRoleList', page:true, id:'getSysRoleListId',limit:5,limits:[5,10,15,20,25]}"
       lay-filter="getSysRoleListFilter" lay-size="lg">
    <thead>
    <tr>
        <th lay-data="{field:'role_key', width:150,align:'center'}">角色编码</th>
        <th lay-data="{align:'center', width:200,  templet:'#templecreate_time'}">创建时间</th>
        <th lay-data="{field:'role_value',align:'center', width:150   }">角色名称</th>
        <th lay-data="{field:'description',align:'center', width:150   }">描述</th>
        <th lay-data="{field:'user_name',align:'center', width:150   }">创建人</th>
        <th lay-data="{ width:250, align:'center', toolbar: '#getSysRoleListBar'}">操作</th>
    </tr>
    </thead>
</table>


<script type="text/html" id="getSysRoleListBar">
    <a class="layui-btn layui-btn-mini" lay-event="detail">查看/编辑权限</a>
    <a class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del">删除</a>
</script>


<!--创建时间-->
<script type="text/html" id="templecreate_time">
    <div class="layui-table-cell  ">{{ Format(d.create_time,"yyyy-M-d h:m:s")}}</div>
</script>

<script th:src="@{/static/js/common.js}"></script>

<script>

    function onloadInit(upload,layform,laydate,element,table,layer) {

        //查询按钮
        initSearch_btn(table);
        table_manger(table,layer,laydate,layform,layui);
    }


    /**
     *  渲染查询按钮
     */
    function initSearch_btn(table) {
        $(".search_btn").on('click',function () {
            table.reload('getSysRoleListId', {
                url: '/SysUserInfoManagerController/getSysRoleList'
                ,where: $(".search_getSysRoleList_form").serializeObject()
            });
        })
    }



    function table_manger(table,layer,laydate,layform){
        //监听工具条
        table.on('tool(getSysRoleListFilter)', function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值

            if (layEvent === 'detail' || layEvent === 'edit') { //查看
                var othis = $(this), method = layEvent;
                active[method] ? active[method].call(data,layui) : '';
            } else if (layEvent === 'del'){//删除
                layer.confirm('真的删除行么', function (index) {

                    //更新url
                    var posturl  = static_path+"CtuManagerController/delCtuser";

                    var objTmp = {id:obj.data.id};
                    $.post(posturl, objTmp, function (result) {
                        console.log(JSON.stringify(result));
                        if (result.code == '1000') {
                            obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        }else{
                            layer.msg(result.msg)
                        }
                    }, "json");

                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);

                });
            }
        });



        //触发事件
        var active = {
            detail: function( ){

                var contenttmp = '<ul id="permission_tree_id"    class="ztree"></ul>';

                var activethis =this;
                //示范一个公告层
                layer.open({
                    type: 1
                    ,title: false //不显示标题栏
                    ,offset: '100px'
                    ,area: '300px;'
                    ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                    ,btn: ['关闭']
                    ,btnAlign: 'c'
                    ,moveType: 1 //拖拽模式，0或者1
                    ,content: contenttmp
                    ,success: function(layero){
                        tree_permission( activethis.role_id);
                    }
                });
            }

        };
    }

   /**
    * 取权限
    */
    function tree_permission( role_id){
        var posturl = static_path + "SysUserInfoManagerController/queryPerssionByRoleId"
        ,objTmp = {"role_id": role_id};

        $.post(posturl, objTmp, function (result) {
            console.log(result);
            var tmpdata =  result.result;
             var arr=[];
//            for(var i=tmpdata.length-1;i>=0;i--){
            for(var i=0;i<tmpdata.length;i++){
                arr.push({id:tmpdata[i].menu_code, pId:tmpdata[i].parent_menucode, checked:tmpdata[i].checked
                    ,name:tmpdata[i].menu_name,open:true,myid:tmpdata[i].id,role_key:tmpdata[i].role_key
                ,menu_type:tmpdata[i].menu_type})
            }
            createmineztree(arr);
        }, "json");

    }

    /**
     * 生成 ztree
     */
    function createmineztree(arr){

        var setting = {
            check: {
                enable: true
                ,autoCheckTrigger: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            callback:{
                onCheck:function(event, treeId, treeNode){
                    console.log(treeNode.role_key + "---, "+treeNode.tId + ", " + treeNode.name + "," + treeNode.checked+" , menu_code:"+ treeNode.id+" id: ," +treeNode.myid);
                    var objTmp = {id:treeNode.myid,role_key:treeNode.role_key,checked:treeNode.checked
                        ,menu_type:treeNode.menu_type,menu_code:treeNode.id}
                        ,posturl= static_path +"SysUserInfoManagerController/updateRolePerssion"
                    $.post(posturl, objTmp, function (result) {
                        console.log(result);

                    }, "json");

                }
            }
        };


        $.fn.zTree.init($("#permission_tree_id"), setting, arr);

    };


</script>
</body>
</html>
